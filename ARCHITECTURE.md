# Документация по архитектуре

## Обзор системы

KAD Parser - комплексная система для скрейпинга и обработки судебных документов из системы арбитражных судов РФ (КАД Арбитр). Следует современной async-first архитектуре с четким разделением ответственности.

## Принципы архитектуры

1. **Async-First**: Async/await повсеместно для максимального параллелизма
2. **Паттерн Repository**: Абстракция доступа к базе данных
3. **Внедрение зависимостей**: Зависимости FastAPI для чистого кода
4. **Плагинная архитектура**: Расширяемость через плагины
5. **Событийная модель**: Система вебхуков для уведомлений
6. **Запланированные задачи**: Celery Beat для периодических операций

## Слои

### 1. Слой API (`src/api/`)

**Приложение FastAPI** с:
- Документацией OpenAPI/Swagger
- Аутентификацией JWT и API ключами
- CORS middleware
- Валидацией запросов с Pydantic
- Асинхронными обработчиками маршрутов

**Маршруты:**
- `/auth` - Аутентификация (регистрация, вход, API ключи)
- `/webhooks` - Управление вебхуками
- `/plugins` - Управление плагинами
- `/cases` - CRUD операции с делами
- `/documents` - Управление документами
- `/analytics` - Статистика и отчетность
- `/export` - Экспорт данных (JSON, CSV, Excel)

### 2. Слой бизнес-логики

**Scraper** (`src/scraper/`):
- `KadArbitrClient` - HTTP клиент для API КАД Арбитр
- `RateLimiter` - Ограничение частоты запросов Token Bucket
- Логика повторов с экспоненциальной задержкой
- Управление сессиями

**Parser** (`src/parser/`):
- `HTMLCaseParser` - Извлечение данных из карточек дел
- `PDFDocumentParser` - Извлечение текста из PDF
- `DOCXDocumentParser` - Извлечение текста из DOCX

**Webhooks** (`src/webhooks/`):
- `WebhookDispatcher` - Диспетчеризация событий
- Генерация HMAC подписей
- Логика повторов с экспоненциальной задержкой
- Отслеживание доставки

**Plugins** (`src/plugins/`):
- `PluginManager` - Загрузка плагинов и управление жизненным циклом
- Базовые классы для различных типов плагинов
- Система хуков для событий жизненного цикла

### 3. Слой данных

**Storage** (`src/storage/`):

**Database** (`src/storage/database/`):
- Асинхронные модели SQLAlchemy 2.0
- Миграции Alembic
- Паттерн Repository для доступа к данным
- Пулы соединений

**Модели:**
```
┌─────────────┐
│    User     │
│  APIKey     │
└─────────────┘
       │
       ├─────────────┐
       │             │
┌──────▼──────┐ ┌───▼────────┐
│   Webhook   │ │    Case    │
│WebhookDelivery│  Participant│
└─────────────┘ │  Document  │
                │  Hearing   │
                └────────────┘
                       │
                ┌──────▼────────┐
                │ScrapingTask   │
                └───────────────┘
```

**Файловое хранилище** (`src/storage/files/`):
- MinIO (S3-совместимое) для документов
- Предподписанные URL для безопасного доступа
- Автоматическое создание бакетов

### 4. Слой задач (`src/tasks/`)

**Celery Workers:**
- `scrape_case_task` - Парсинг дела из КАД Арбитр
- `parse_document_task` - Парсинг содержимого документа
- `retry_failed_webhooks_task` - Повтор неудавшихся доставок вебхуков

**Планировщик Celery Beat:**
- Повтор неудавшихся вебхуков (каждую минуту)
- Очистка старых доставок (ежедневно)
- Обновление статистики (каждый час)
- Проверка зависших задач (каждые 15 минут)
- Очистка истекших сессий (ежедневно)

### 5. Слой представления

**Веб-интерфейс** (`src/web/`):
- Серверный рендеринг с Jinja2
- Tailwind CSS для стилизации
- HTMX для динамических обновлений
- Alpine.js для интерактивности
- Chart.js для визуализаций

**CLI** (`src/cli/`):
- CLI интерфейс на базе Typer
- Форматирование Rich
- Интерактивные запросы

## Поток данных

### Поток парсинга

```
Запрос пользователя
    │
    ▼
API эндпоинт (/cases/scrape)
    │
    ▼
Задача Celery (scrape_case_task)
    │
    ├─► KadArbitrClient
    │   └─► API КАД Арбитр
    │
    ├─► HTMLCaseParser
    │   └─► Извлечение данных дела
    │
    ├─► Слой Repository
    │   └─► Сохранение в PostgreSQL
    │
    ├─► Хранилище MinIO
    │   └─► Сохранение файлов документов
    │
    ├─► WebhookDispatcher
    │   └─► Отправка уведомлений о событиях
    │
    └─► Ответ
```

### Поток доставки вебхуков

```
Триггер события
    │
    ▼
WebhookDispatcher.dispatch()
    │
    ├─► Поиск подписанных вебхуков
    │
    ├─► Создание записей WebhookDelivery
    │
    ├─► Попытка доставки
    │   ├─► Генерация HMAC подписи
    │   ├─► HTTP POST на URL вебхука
    │   ├─► Запись ответа
    │   └─► Обновление статистики
    │
    └─► При неудаче:
        ├─► Планирование повтора (экспоненциальная задержка)
        └─► Celery Beat подхватывает для повтора
```

### Жизненный цикл плагина

```
Запуск приложения
    │
    ▼
PluginManager.load_plugins()
    │
    ├─► Сканирование директории plugins
    │
    ├─► Для каждого файла плагина:
    │   ├─► Импорт модуля
    │   ├─► Поиск классов Plugin
    │   ├─► Создание экземпляра плагина
    │   ├─► Вызов plugin.initialize()
    │   └─► Регистрация хуков
    │
    └─► Сохранение в реестре плагинов

Выполнение хука
    │
    ▼
PluginManager.execute_hook(hook, context)
    │
    ├─► Поиск плагинов, подписанных на хук
    │
    ├─► Для каждого плагина:
    │   ├─► Проверка включен ли
    │   ├─► Вызов plugin.on_hook(hook, context)
    │   └─► Обновление контекста результатом
    │
    └─► Возврат финального контекста

Остановка приложения
    │
    ▼
PluginManager.unload_all()
    │
    └─► Для каждого плагина:
        └─► Вызов plugin.cleanup()
```

## Архитектура безопасности

### Аутентификация

```
Учетные данные пользователя
    │
    ▼
/auth/login
    │
    ├─► Проверка пароля (bcrypt)
    │
    ├─► Генерация JWT токена
    │   ├─► Payload: {sub: user_id, username}
    │   ├─► Подпись SECRET_KEY
    │   └─► Установка срока действия
    │
    └─► Возврат токена

Защищенный эндпоинт
    │
    ▼
Authorization Header: Bearer {token}
    │
    ▼
Зависимость get_current_user()
    │
    ├─► Декодирование JWT токена
    ├─► Проверка подписи
    ├─► Проверка срока действия
    ├─► Загрузка пользователя из БД
    ├─► Проверка активности пользователя
    │
    └─► Возврат пользователя или ошибка 401
```

### Аутентификация по API ключу

```
Запрос с заголовком X-API-Key
    │
    ▼
Зависимость verify_api_key()
    │
    ├─► Поиск API ключа в БД
    ├─► Проверка is_active
    ├─► Проверка срока действия
    ├─► Обновление last_used_at
    │
    └─► Возврат API ключа или ошибка 401
```

## Масштабируемость

### Горизонтальное масштабирование

- **API серверы**: Несколько экземпляров FastAPI за балансировщиком нагрузки
- **Celery Workers**: Масштабирование воркеров в зависимости от длины очереди
- **БД**: PostgreSQL с репликами для чтения
- **Redis**: Redis Cluster для высокой доступности
- **MinIO**: Распределенный кластер MinIO

### Стратегия кэширования

- **Redis**: Данные сессий, счетчики ограничения частоты
- **БД**: Пулы соединений, кэширование результатов запросов
- **HTTP**: Клиентское кэширование с ETag

### Оптимизации производительности

- Асинхронные запросы к БД с asyncpg
- Пакетные вставки для массовых операций
- Пулы соединений (БД, HTTP, Redis)
- Ограничение частоты для предотвращения злоупотреблений
- Ленивая загрузка связей
- Пагинация для больших наборов данных

## Мониторинг и наблюдаемость

### Логирование

- Структурированное логирование с structlog
- Уровни логов: DEBUG, INFO, WARNING, ERROR
- Контекст: request_id, user_id, task_id
- Вывод: JSON для продакшена, цветной для разработки

### Метрики (будущее)

- Экспорт метрик Prometheus
- Гистограммы длительности запросов
- Счетчики частоты ошибок
- Метрики длины очереди
- Метрики пула соединений БД

### Трассировка (будущее)

- Интеграция OpenTelemetry
- Распределенная трассировка между сервисами
- Визуализация потока запросов

## Развертывание

### Docker Compose

```
┌─────────────────────────────────────────┐
│     Балансировщик нагрузки / Nginx      │
└────┬────────────────────────────────┬───┘
     │                                │
┌────▼─────┐                    ┌────▼─────┐
│   API    │                    │   API    │
│Экземпляр │                    │Экземпляр │
└────┬─────┘                    └────┬─────┘
     │                                │
     └────────────┬───────────────────┘
                  │
     ┌────────────┼────────────┬──────────┐
     │            │            │          │
┌────▼─────┐┌────▼─────┐┌────▼─────┐┌───▼────┐
│PostgreSQL││  Redis   ││  MinIO   ││ Celery │
│          ││          ││          ││ Worker │
└──────────┘└──────────┘└──────────┘└────┬───┘
                                         │
                                    ┌────▼────┐
                                    │  Celery │
                                    │  Beat   │
                                    └─────────┘
```

### Переменные окружения

- **Приложение**: DEBUG, SECRET_KEY, JWT_EXPIRATION
- **БД**: POSTGRES_*
- **Redis**: REDIS_*
- **MinIO**: MINIO_*
- **Celery**: BROKER_URL, RESULT_BACKEND

## Будущие улучшения архитектуры

1. **Event Sourcing**: Хранение всех событий для аудита
2. **CQRS**: Разделение моделей чтения и записи
3. **GraphQL**: Альтернативное API с подписками
4. **gRPC**: Высокопроизводительная коммуникация между сервисами
5. **Service Mesh**: Istio для обнаружения сервисов и маршрутизации
6. **Kubernetes**: Оркестрация контейнеров
7. **Мультитенантность**: Изолированные данные для каждой организации
