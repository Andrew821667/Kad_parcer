-- ============================================================================
-- КАД Арбитр Database Schema
-- ============================================================================
-- База данных метаданных арбитражных дел РФ
-- Версия: 1.0
-- Дата: 2024-12-12
-- ============================================================================

-- ============================================================================
-- PRAGMA оптимизации (выполняются автоматически в SQLiteManager)
-- ============================================================================

PRAGMA journal_mode = WAL;              -- Write-Ahead Logging для производительности
PRAGMA cache_size = -64000;             -- 64 MB кэш в памяти
PRAGMA mmap_size = 1073741824;          -- 1 GB memory-mapped I/O
PRAGMA synchronous = NORMAL;            -- Баланс безопасности и скорости
PRAGMA temp_store = MEMORY;             -- Временные таблицы в RAM
PRAGMA foreign_keys = ON;               -- Включить foreign keys

-- ============================================================================
-- ТАБЛИЦА: cases
-- ============================================================================
-- Метаданные дел (5 миллионов записей × 1 KB = 5 GB)
-- Primary Key: case_number (уникальный номер дела)
-- ============================================================================

CREATE TABLE IF NOT EXISTS cases (
    case_number TEXT PRIMARY KEY,        -- Номер дела (А40-12345-2024)
    court TEXT,                          -- Суд (АС города Москвы)
    registration_date DATE,              -- Дата регистрации (YYYY-MM-DD)
    year INTEGER,                        -- Год регистрации
    status TEXT,                         -- Статус дела
    parties TEXT,                        -- Стороны дела (текст или JSON)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- Время создания записи
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP   -- Время последнего обновления
);

-- ============================================================================
-- ТАБЛИЦА: documents
-- ============================================================================
-- Ссылки на документы (20 миллионов документов)
-- Хранятся только ссылки на MD файлы, сами файлы в documents/YYYY/case_number/
-- ============================================================================

CREATE TABLE IF NOT EXISTS documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- ID документа
    case_number TEXT NOT NULL,             -- Номер дела (FK -> cases.case_number)
    doc_type TEXT,                         -- Тип документа (Решение, Постановление)
    instance TEXT,                         -- Инстанция (Первая, Апелляция, Кассация)
    is_final BOOLEAN DEFAULT 0,            -- Завершающий документ (1/0)
    pdf_url TEXT,                          -- Оригинальный URL PDF (для reference)
    md_path TEXT,                          -- Путь к MD файлу (documents/YYYY/...)
    parsed_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- Время парсинга
    file_size INTEGER,                     -- Размер файла в байтах

    FOREIGN KEY (case_number) REFERENCES cases(case_number)
        ON DELETE CASCADE                  -- Удалить документы при удалении дела
);

-- ============================================================================
-- ИНДЕКСЫ для быстрых запросов
-- ============================================================================

-- Индекс по году (для фильтрации дел по годам)
CREATE INDEX IF NOT EXISTS idx_cases_year
    ON cases(year);

-- Индекс по суду (для фильтрации по судам)
CREATE INDEX IF NOT EXISTS idx_cases_court
    ON cases(court);

-- Индекс по дате регистрации (для сортировки и фильтрации по датам)
CREATE INDEX IF NOT EXISTS idx_cases_registration_date
    ON cases(registration_date);

-- Индекс по номеру дела в таблице documents (для быстрого поиска документов дела)
CREATE INDEX IF NOT EXISTS idx_documents_case_number
    ON documents(case_number);

-- Индекс по типу документа (для фильтрации по типам)
CREATE INDEX IF NOT EXISTS idx_documents_doc_type
    ON documents(doc_type);

-- ============================================================================
-- ПРИМЕРЫ ЗАПРОСОВ
-- ============================================================================

-- Получить все дела 2024 года
-- SELECT * FROM cases WHERE year = 2024 ORDER BY registration_date;

-- Получить статистику по судам
-- SELECT court, COUNT(*) as count FROM cases GROUP BY court ORDER BY count DESC;

-- Получить все документы дела
-- SELECT * FROM documents WHERE case_number = 'А40-12345-2024';

-- Получить статистику по типам документов
-- SELECT doc_type, COUNT(*) as count FROM documents GROUP BY doc_type ORDER BY count DESC;

-- Получить все финальные документы
-- SELECT * FROM documents WHERE is_final = 1;

-- ============================================================================
-- ФИЛЬТР ВАЖНЫХ ДОКУМЕНТОВ (для reference)
-- ============================================================================
-- Типы документов, которые мы скачиваем и конвертируем в MD:
--   - "Решение"                           (Первая инстанция)
--   - "Постановление"                     (Апелляция/Кассация)
--   - "Определение Верховного Суда"       (ВС РФ)
--   - "Определение о прекращении"         (Завершающие)
--   - "Определение об утверждении мирового" (Мировое соглашение)
--
-- Не скачиваем:
--   - "Протокол"
--   - Промежуточные определения
-- ============================================================================
